<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="styles.css">
    <title>Admin Dashboard</title>
</head>
<body>
    <script type="module" src="navbar.js"></script>

    <main class="container">
        <h1 style="text-shadow: 0 2px 10px rgba(0,0,0,0.2);">Control Tower</h1>

        <div class="admin-section">
            <button class="drop-btn" id="toggleSchedule">
                <span>Monthly 15-Leg Schedule Maker</span>
                <span class="arrow">â–¼</span>
            </button>
            <div class="dropdown-content" id="scheduleDropdown">
                <div style="margin-top: 20px;">
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <input type="text" id="targetCallsign" placeholder="Pilot Callsign" style="flex:1; padding:10px; border-radius:8px; border:none;">
                        <input type="email" id="targetEmail" placeholder="Pilot Email" style="flex:1; padding:10px; border-radius:8px; border:none;">
                    </div>
                    <div id="legsWrapper"></div>
                    <button id="saveScheduleBtn" style="background: white; color: #ce42f5; width:100%; margin-top:20px; font-weight:900;">DEPLOY 15 LEGS</button>
                </div>
            </div>
        </div>

        <section class="airline-stats-box">
            <h3>Monthly Operations (Global)</h3>
            <div style="display: flex; justify-content: space-around;">
                <div><small>Pilots</small><h2 id="totalP">0</h2></div>
                <div><small>Pireps</small><h2 id="totalF">0</h2></div>
                <div><small>Distance</small><h2 id="totalD">0 nm</h2></div>
            </div>
        </section>

        <section class="career-section">
            <h3 style="color:white;">Type Rating Requests</h3>
            <div id="ratingRequestsArea">No pending requests</div>
        </section>
    </main>

    <script type="module">
        import { supabase } from './supabase.js';

        // Toggle Animation
        document.getElementById('toggleSchedule').onclick = () => {
            document.getElementById('scheduleDropdown').classList.toggle('show');
        };

        // Generate 15 Legs
        const wrapper = document.getElementById('legsWrapper');
        for(let i=1; i<=15; i++) {
            wrapper.innerHTML += `
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <span style="width:20px;">${i}</span>
                    <input type="text" placeholder="Route" id="rt-${i}" style="flex:2; border:none; border-radius:4px; padding:5px;">
                    <input type="text" placeholder="Flight#" id="fn-${i}" style="flex:1; border:none; border-radius:4px; padding:5px;">
                    <input type="number" placeholder="NM" id="di-${i}" style="flex:1; border:none; border-radius:4px; padding:5px;">
                    <input type="number" placeholder="Time" id="ti-${i}" style="flex:1; border:none; border-radius:4px; padding:5px;">
                </div>`;
        }

        // Monthly Stats Logic (Starts from Zero)
        async function updateAdminStats() {
            const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString();
            const { data: pireps } = await supabase.from('pireps').select('distance_flown').eq('status', 'Approved').gte('created_at', startOfMonth);
            const { count: pilots } = await supabase.from('profiles').select('*', { count: 'exact', head: true });
            
            const dist = pireps?.reduce((a, b) => a + (b.distance_flown || 0), 0) || 0;
            document.getElementById('totalP').innerText = pilots || 0;
            document.getElementById('totalF').innerText = pireps?.length || 0;
            document.getElementById('totalD').innerText = dist.toLocaleString() + " nm";
        }
        updateAdminStats();
    </script>
</body>
</html>
