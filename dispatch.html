<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="styles.css">
    <title>Dispatch | Crew Centre</title>
</head>
<body>
    <script type="module" src="navbar.js"></script>
    <main class="container">
        <h1>Monthly Flight Schedule</h1>
        <div id="scheduleGrid"></div>
    </main>
    <script type="module">
        import { supabase } from './supabase.js';
        async function loadDispatch() {
            const { data: { user } } = await supabase.auth.getUser();
            const { data: legs } = await supabase.from('schedules').select('*').eq('pilot_id', user.id).order('leg_num');
            const { data: pireps } = await supabase.from('pireps').select('leg_num').eq('pilot_id', user.id);
            
            const completedLegs = pireps.map(p => p.leg_num);
            const grid = document.getElementById('scheduleGrid');

            legs.forEach((leg, index) => {
                const isLocked = leg.leg_num > 1 && !completedLegs.includes(leg.leg_num - 1);
                const isFiled = completedLegs.includes(leg.leg_num);

                grid.innerHTML += `
                    <div class="flight-card ${isLocked ? 'locked' : ''}">
                        <div class="card-top">${leg.flight_no} - ${leg.route}</div>
                        <div class="card-mid">
                            <span class="leg-indicator">Leg ${leg.leg_num}</span>
                            <span class="time-indicator">${leg.flight_time}h</span>
                        </div>
                        <div class="card-bottom">Distance: ${leg.distance}nm</div>
                        <div class="card-buttons">
                            <button onclick="location.href='pirep.html?leg=${leg.leg_num}'" ${isLocked || isFiled ? 'disabled' : ''}>
                                ${isFiled ? 'Completed' : 'Dispatch'}
                            </button>
                            ${!isLocked && !isFiled ? `<button onclick="location.href='pirep.html?leg=${leg.leg_num}'">File Pirep</button>` : ''}
                        </div>
                    </div>`;
            });
        }
        loadDispatch();
    </script>
</body>
</html>
